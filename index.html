<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - geometry - terrain</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				color: #61443e;
				font-family:Monospace;
				font-size:13px;
				text-align:center;

				background-color: #bfd1e5;
				margin: 0px;
				overflow: hidden;
			}

			#info {
				position: absolute;
				top: 0px; width: 100%;
				padding: 5px;
			}

			a {

				color: #a06851;
			}

		</style>
	</head>
	<body>

		<div id="container"></div>

		<script src="js/three.js"></script>

		<script src="js/OrbitControls.js"></script>
 		<script src="js/Detector.js"></script>
		<script src="js/stats.min.js"></script>
		<script src="js/d3.v4.min.js"></script>
		<script>

			d3.csv("data/knn_surface.csv", data => {
			// d3.csv("data/bayes_surface.csv", data => {


				Array.prototype.unique = function() {
				    var arr = [];
				    for(var i = 0; i < this.length; i++) {
				        if(!arr.includes(this[i])) {
				            arr.push(this[i]);
				        }
				    }
				    return arr;
				}

				function linspace(a,b,length = 100){
					var dist = b - a,
						int_length = dist/length;

					return [...Array(length).keys()].map( i => a + i*int_length)
				}

				var x_range = d3.extent(data, d => +d.x),
					x_width = x_range[1] - x_range[0],
					y_range = d3.extent(data, d => +d.y),
					y_width = y_range[1] - y_range[0],
					z_range = d3.extent(data, d => +d.z),
					unique_x = data.map(d => +d.x).unique().length,
					unique_y = data.map(d => +d.y).unique().length;

				// console.log("total_num =", data.length);

				if ( ! Detector.webgl ) {
					Detector.addGetWebGLMessage();
					document.getElementById( 'container' ).innerHTML = "";
				}

				var container, stats;

				var camera, controls, scene, renderer;

				var mesh, texture;
				var width = window.innerWidth,
					height = window.innerHeight;

				var clock = new THREE.Clock();

				init();
				animate();

				function init() {

					//==============================================================
					//======== General three setup  ================================
					//==============================================================
					//document container
					container = document.getElementById( 'container' );

					//Camera initialization
					camera = new THREE.PerspectiveCamera( 60, width / height, 1, 1000 );
			        camera.position.x = 0;
			        camera.position.y = -8;
			        camera.position.z = -4;

					//scene init
					scene = new THREE.Scene();

					//Lights
					var light1 = new THREE.PointLight(0xffffff);
					light1.position.set(0,0,-100);
					scene.add(light1);

					var light2 = new THREE.PointLight(0xffffff);
					light2.position.set(0,0,100);
					scene.add(light2);

					//Controls
					controls = new THREE.OrbitControls( camera, container );
					controls.addEventListener( 'change', render ); // remove when using animation loop

					//Set up the renderer
					renderer = new THREE.WebGLRenderer();
					renderer.setClearColor( 0xbfd1e5 );
					renderer.setPixelRatio( window.devicePixelRatio );
					renderer.setSize( width, height);
					container.innerHTML = "";
					//send to the container
					container.appendChild( renderer.domElement );

					//FPS counter.
					stats = new Stats();
					container.appendChild( stats.dom );

					//Resize behavior.
					window.addEventListener( 'resize', onWindowResize, false );

					//==============================================================
					//======== Surface construction ================================
					//==============================================================

					//geometry of surface
					var geometry = new THREE.PlaneBufferGeometry(x_width, y_width, unique_x - 1, unique_y - 1 );

					//spits out an array of (x,y,z = 0) times the number of points we have.
					var vertices = geometry.attributes.position.array;

					//fill in the z coordinate with our data
					for ( var i = 0; i < data.length; i ++) vertices[(3*i) +2] = +data[i].z*3;

					geometry.computeBoundingBox();
					var zMin = geometry.boundingBox.min.z;
					var zMax = geometry.boundingBox.max.z;
					var zRange = zMax - zMin;

					//material of surface
					var material = new THREE.MeshPhongMaterial({
						   color: 0xfeb24c,
						   specular: 0x0,
						   shading: THREE.FlatShading,
						   side: THREE.DoubleSide,
						   wireframe:false
					});

					//put together geometry and material
					mesh = new THREE.Mesh( geometry, material );

					//make an object and put our surface into it.
					var surface_plot = new THREE.Object3D();
					surface_plot.add(mesh);
					surface_plot.position.set(0,0,0);
					scene.add( surface_plot );

				}

				function onWindowResize() {

					camera.aspect = window.innerWidth / window.innerHeight;
					camera.updateProjectionMatrix();

					renderer.setSize( window.innerWidth, window.innerHeight );
				}

				function animate() {

					requestAnimationFrame( animate );

					controls.update();
					console.log(camera.position)
					render();
					stats.update();
				}

				function render() {
					renderer.render( scene, camera );
				}
			});


		</script>

	</body>
</html>
